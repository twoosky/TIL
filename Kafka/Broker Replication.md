# Broker Replication
* `복제`는 클러스터로 묶인 브로커 중, 일부에 장애가 발생하더라도 데이터를 유실하지 않고, 안전하게 사용하기 위함이다.
* 데이터 복제는 파티션 단위로 이루어지고, 토픽을 생성할 때 파티션의 복제 개수(replication factor)도 같이 설정한다.
* default는 브로커에 설정된 옵션 값이고, 복제 최댓값은 브로커 개수만큼 설정 가능
* 각 브로커에 복제된 파티션은 `리더`와 `팔로워`로 구성된다.
* `리더`는 프로듀서 또는 컨슈머와 직접 통신하는 파티션이고, `팔로워`는 나머지 복제 데이터를 갖고 있는 파티션이다.
* 팔로워 파티션들은 리더 파티션의 오프셋을 확인하여 현재 자신이 가지고 있는 오프셋과 차이가 나는 경우, 리더 파티션으로부터 데이터를 가져와서 자신의 파티션에 저장한다.
* 복제 개수만큼의 저장 용량이 증가하지만, 고가용성을 높이기 위해 운영할 때 2개 이상의 복제 개수를 정하는 것이 중요하다.

<img src="https://github.com/twoosky/TIL/assets/50009240/63ab935b-c665-42dd-9b53-b8ff95acb8a9" width="540" height="210">

> 팔로워 파티션들의 offset은 0이고, 컨슈머가 데이터를 읽고 오프셋을 커밋해 리더 파티션의 offset이 2가 된 경우 리더 파티션의 offset 1,2의 레코드를 가져와 각 팔로워 파티션에 저장하는 것을 복제라고 한다.

## Broker에 장애가 발생한 경우
* 리더 파티션의 브로커가 다운되면, ***팔로워파티션 중 하나가 리더 파티션으로 승격된다.***
* 이로 인해, 데이터가 유실되지 않고, 프로듀서나 컨슈머와 지속적으로 데이터를 주고 받을 수 있다.
* metric과 같이 데이터 일부가 유실되어도 무관하고, 데이터 처리 속도가 중요한 경우 복제 개수 1로 설정
* 금융 정보와 같이 유실이 일어나면 안되는 데이터의 경우 복제 개수 3으로 설정
<img src="https://github.com/twoosky/TIL/assets/50009240/33e2d0b4-7857-49f5-a8d6-43bdd9e54f48" width="550" height="240">

## ISR : In-Sync-Replicas
* `ISR`: 리더 파티션과 팔로워 파티션이 모두 싱크(동기화)된 상태를 의미한다.
* 동기화된 상태는 리더 파티션의 모든 데이터가 팔로워 파티션에 복제된 상태이다.
* 동기화되지 않은 상태에서 브로커가 다운되어, 팔로워 파티션이 리더 파티션으로 승격되면 데이터가 유실될 수 있다.
* 따라서, 아래 옵션으로 팔로워 파티션의 리더 승격 여부를 설정 가능
* `unclean.leader.election.enable=true` : 유실을 감수함. 동기화 안된 팔로워 파티션을 리더로 승급
* `unclean.leader.election.enable=false` : 유실을 감수하지 않음. 해당 브로커가 복구될 때까지 중단

<img src="https://github.com/twoosky/TIL/assets/50009240/ce668811-7c5e-4037-a8ac-319015c52f09" width="750" height="230">
