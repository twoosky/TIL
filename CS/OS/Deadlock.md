# Deadlock
두 개 이상의 프로세스나 스레드가 서로 자원을 얻지 못해서 다음 처리를 하지 못하는 상태  
무한히 다음 자원을 기다리게 되는 상태를 말한다.  
시스템적으로 한정된 자원을 여러 곳에서 사용하려고 할 때 발생한다.  

# Deadlock 발생하는 경우
<image src="https://t1.daumcdn.net/cfile/tistory/25173B4B5407E38228" width="500" height="170">

프로세스(또는 스레드) 1, 2가 존재  
`프로세스1, 2` 모두 `resource 1, 2`를 얻어야 한다고 가정해보자.

* 프로세스1이 자원1을 점유하고 있고, 프로세스2가 자원2를 점유하고 있는 상태
* 프로세스1은 자원2를 얻기위해 대기, 프로세스2는 자원1을 얻기위해 대기  

즉, 서로가 서로를 기다리다 아무도 실행되지 못하는 상황을 **Deadlock** 이라고 한다.

## Deadlock 발생 원인 
* 프로그램 code가 복잡해 의존성이 생기는 경우 발생  
* 멀티 프로그래밍 환경에서 한정된 자원을 얻기 위해 서로 경쟁하는 상황에서 발생  
* 모듈화된 함수 내부에서 lock()을 사용할 경우 발생

# Deadlock 발생 조건
아래 4가지 모두 성립해야Deadlock 발생  
(하나라도 성립하지 않으면 데드락 문제 해결 가능)  

* **상호 배제: Mutual exclusion**  
  * 자원은 한 번에 한 프로세스만 사용할 수 있다.  
* **점유 대기: Hold and wait**
  * 프로세스가 최소 하나 이상의 자원을 점유하고 있는 상태로 다른 프로세스가 사용하고 있는 자원을 점유하기 위해 대기하는 상황  
* **비선점: No preemption**
  * 프로세스에 할당된 자원은 사용이 끝날 때까지 강제로 빼앗을 수 없다.  
* **순환 대기: Circular wait**
  * 프로세스 집합에서 순환 형태로 자원을 대기하고 있어야 한다.  
  
# Deadlock 처리
* **예방(Prevention)**: 교착 상태(Deadlock) 발생 조건 중 하나를 제거해 해결
  
  > * `상호배제 부정`: 여러 프로세스가 공유 자원을 사용, 이 방법은 동시성문제를 발생시키므로 적절하지 않다.
  > * `점유대기 부정`: 프로세스 실행에 필요한 모든 자원을 점유할 수 있을 때까지 작업 보류 후 모든 자원을 할당받은 뒤 실행.   
                    따라서 프로세스 실행 중 자원을 점유한 채로 다른 자원을 점유하기 위한 대기를 하지 않도록 한다.
  > * `비선점 부정`: 자원 점유 중인 프로세스가 다른 자원을 요구할 때 가진 자원 반납  
  > * `순환대기 부정`: 자원에 고유번호 할당 후 순서대로 자원 요구  
  
* **회피(avoidance)**: Deadlock 발생 시 회피하는 방법
  > 은행원 알고리즘(Banker's Algorithm)
  > * 은행에서 모든 고객의 요구가 충족되도록 현금을 할당하는데서 유래함.  
  > * 프로세스가 자원을 요구할 때, 시스템은 자원을 할당한 후에도 안정 상태로 남아있게 되는지 사전에 검사하여 교착상태 회피
  > * 안정 상태면 자원 할당, 아니면 다른 프로세스들의 자원 해지까지 대기
  
  > 안정 상태(Safe state): 프로세스들이 요청하는 모든 자원을, 데드락을 발생시키지 않으면서도 차례로 모두에게 할당할 수 있는 상태

* **탐지(Detection)**: Deadlock 발생 여부 탐지
  > * 자원 할당 그래프를 통해 교착 상태 탐지
  >   * 자원 할당 그래프는 요청선과 할당선으로 이루어진다.
  >   * 그래프에 Cycle이 존재하면 Deadlock 가능성이 있다. 
  > * 자원 요청시, 탐지 알고리즘을 실행시켜 그에 대한 오버헤드가 발생한다.
* **회복(recovery)**: Deadlock이 되도록 허용한 다음 회복시키는 방법 
  * 교착 상태 일으킨 프로세스를 종료하거나, 할당된 자원을 해제시켜 회복시키는 방법
  > 프로세스 종료 방법
  > * 교착 상태(Deadlock)의 프로세스를 모두 중지
  > * 교착 상태가 제거될 때까지 하나씩 프로세스 중지
  
  
  > 자원 선점 방법
  > * 교착 상태의 프로세스가 점유하고 있는 자원을 선점해 다른 프로세스에게 할당
  >   * 자원 선점 후 해당 프로세스는 일시정지 시킴
  > * 우선 순위가 낮은 프로세스나 수행 횟수 적은 프로세스 위주로 프로세스 자원 선점(빼앗음)
